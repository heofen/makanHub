{% extends 'base.html' %}
{% load core_extras %}

{% block title %}–ú–æ–π –≤–∞–π–± - makanHub{% endblock %}

{% block extra_head %}
{# –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ª–∞–π–∫–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã #}
<style>
    .vote-buttons button {
        margin-right: 5px;
        min-width: 80px;
    }
    .vote-buttons .active-like {
        background-color: #198754;
        color: white;
        border-color: #198754;
    }
     .vote-buttons .active-dislike {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
    <h1>–ú–æ–π –≤–∞–π–± ‚ú®</h1>

    {% if recommendations %}
        <p class="text-muted">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–∫–∞: {{ source_track.artist }} - {{ source_track.title }}</p>
        <h2 class="mt-4">–ü–æ—Ö–æ–∂–∏–µ —Ç—Ä–µ–∫–∏:</h2>
        <div class="list-group mt-3">
            {% for track in recommendations %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{% url 'track_detail' track.pk %}"><strong>{{ track.artist }} - {{ track.title }}</strong></a>
                        <small class="text-muted d-block">
                            {% if track.genre %}–ñ–∞–Ω—Ä: {{ track.genre.name }}{% endif %}
                            (ID: {{ track.pk }})
                        </small>
                    </div>
                    {# –ë–ª–æ–∫ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤ #}
                    <div class="vote-buttons ms-3" data-track-id="{{ track.pk }}" data-vote-url="{% url 'vote_track' track.pk %}">
                        {% with user_vote=user_votes|get_item:track.pk %}
                            <button class="btn btn-outline-success btn-sm {% if user_vote == 1 %}active-like{% endif %}" data-vote-type="like">
                                <span class="like-count">{{ track.likes_count }}</span> üëç
                            </button>
                            <button class="btn btn-outline-danger btn-sm {% if user_vote == -1 %}active-dislike{% endif %}" data-vote-type="dislike">
                                <span class="dislike-count">{{ track.dislikes_count }}</span> üëé
                            </button>
                        {% endwith %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% elif source_track %}
        <div class="alert alert-info mt-4" role="alert">
            –ú—ã –ø–æ–¥–æ–±—Ä–∞–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–∫–∞ "{{ source_track.artist }} - {{ source_track.title }}", –Ω–æ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ—Ö–æ–∂–∏—Ö —Ç—Ä–µ–∫–æ–≤ –≤ –∏–Ω–¥–µ–∫—Å–µ Annoy.
            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ <a href="{% url 'my_vibe' %}" class="alert-link">–æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–π–±</a> –∏–ª–∏ <a href="{% url 'home' %}" class="alert-link">–ø–æ–∏—Å–∫–∞—Ç—å —á—Ç–æ-—Ç–æ –µ—â–µ</a>.
        </div>
    {% else %}
        <div class="alert alert-warning mt-4" role="alert">
            –ü–æ–∫–∞ –Ω–µ –º–æ–∂–µ–º –ø–æ–π–º–∞—Ç—å –≤–∞—à –≤–∞–π–±! üò• –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'home' %}" class="alert-link">–ø–æ—Å—Ç–∞–≤—å—Ç–µ –ª–∞–π–∫–∏</a> —Ç—Ä–µ–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'home' %}" class="btn btn-secondary">&larr; –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        {% if recommendations or source_track %}
            <a href="{% url 'my_vibe' %}" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å –≤–∞–π–±</a>
        {% endif %}
    </div>

{% endblock %}

{% block extra_scripts %}
{# –ö–æ–ø–∏—Ä—É–µ–º JS –¥–ª—è AJAX –ª–∞–π–∫–æ–≤ –∏–∑ track_detail.html #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.vote-buttons').forEach(voteButtonsContainer => {
        if (!voteButtonsContainer) return;
        const trackId = voteButtonsContainer.dataset.trackId;
        const voteUrl = voteButtonsContainer.dataset.voteUrl;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';

        voteButtonsContainer.addEventListener('click', function(event) {
            let targetButton = null;
            if (event.target.tagName === 'BUTTON' && event.target.dataset.voteType) {
                targetButton = event.target;
            } else if (event.target.parentElement.tagName === 'BUTTON' && event.target.parentElement.dataset.voteType) {
                 targetButton = event.target.parentElement; // –ö–ª–∏–∫ –ø–æ –∏–∫–æ–Ω–∫–µ –∏–ª–∏ —Å—á–µ—Ç—á–∏–∫—É –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏
            }

            if (targetButton) {
                const button = targetButton;
                const voteType = button.dataset.voteType;

                fetch(voteUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: `vote_type=${voteType}`
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const likeButton = voteButtonsContainer.querySelector('button[data-vote-type="like"]');
                        const dislikeButton = voteButtonsContainer.querySelector('button[data-vote-type="dislike"]');
                        likeButton.querySelector('.like-count').textContent = data.likes_count;
                        dislikeButton.querySelector('.dislike-count').textContent = data.dislikes_count;

                        likeButton.classList.remove('active-like');
                        dislikeButton.classList.remove('active-dislike');
                        if (data.user_vote === 1) likeButton.classList.add('active-like');
                        else if (data.user_vote === -1) dislikeButton.classList.add('active-dislike');
                    } else {
                        console.error('Vote failed:', data);
                        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.");
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.");
                });
            }
        });
    });
});
</script>
{% endblock %} 