{% extends 'base.html' %}
{% load static %}
{% load core_extras %} {# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—à–∏ —Ç–µ–≥–∏ #}

{% block title %}{{ track.artist }} - {{ track.title }} - makanHub{% endblock %}

{% block extra_head %}
<style>
    .vote-buttons button {
        margin-right: 5px;
        min-width: 80px; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ —Å–∏–ª—å–Ω–æ –º–µ–Ω—è–ª–∏ —Ä–∞–∑–º–µ—Ä */
    }
    .vote-buttons .active-like {
        background-color: #198754; /* –ó–µ–ª–µ–Ω—ã–π Bootstrap */
        color: white;
        border-color: #198754;
    }
     .vote-buttons .active-dislike {
        background-color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π Bootstrap */
        color: white;
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h1>{{ track.artist }} - {{ track.title }}</h1>
    </div>
    <div class="card-body">
        <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> {{ track.artist }}</p>
        <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ track.title }}</p>
        <p><strong>–ñ–∞–Ω—Ä:</strong> {{ track.genre.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
        <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ track.duration }} —Å–µ–∫—É–Ω–¥</p>
        {% if track.filepath %}
            <p><strong>–ê—É–¥–∏–æ:</strong></p>
            <audio controls controlsList="nodownload" class="w-100">
                <source src="{{ track.filepath.url }}" type="audio/mpeg"> {# –£—Ç–æ—á–Ω–∏—Ç—å MIME type, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ #}
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
            </audio>
        {% else %}
            <p>–ê—É–¥–∏–æ—Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</p>
        {% endif %}

        {# --- –ë–ª–æ–∫ –õ–∞–π–∫–æ–≤/–î–∏–∑–ª–∞–π–∫–æ–≤ --- #}
        <div class="mt-3 vote-buttons" data-track-id="{{ track.pk }}" data-vote-url="{% url 'vote_track' track.pk %}">
            {% if user.is_authenticated %}
                {# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å) - –ø–µ—Ä–µ–¥–∞–µ–º –∏–∑ view #}
                {% with user_vote=user_votes|get_item:track.pk %}
                    <button class="btn btn-outline-success btn-sm {% if user_vote == 1 %}active-like{% endif %}" data-vote-type="like">
                        <span class="like-count">{{ track.likes_count }}</span> üëç
                    </button>
                    <button class="btn btn-outline-danger btn-sm {% if user_vote == -1 %}active-dislike{% endif %}" data-vote-type="dislike">
                        <span class="dislike-count">{{ track.dislikes_count }}</span> üëé
                    </button>
                {% endwith %}
            {% else %}
                <span class="text-muted me-2">–ù—Ä–∞–≤–∏—Ç—Å—è: {{ track.likes_count }}</span>
                <span class="text-muted">–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è: {{ track.dislikes_count }}</span>
                <small class="ms-2"><a href="{% url 'login' %}?next={{ request.path }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å.</small>
            {% endif %}
        </div>
        {# --- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –õ–∞–π–∫–æ–≤/–î–∏–∑–ª–∞–π–∫–æ–≤ --- #}

        {# –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ #}
        <div class="mt-3">
             <a href="{% url 'track_recommendations' track.pk %}" class="btn btn-info">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Ç—Ä–µ–∫–∏</a>
        </div>

        {# –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è #}
        {% if user.is_authenticated and user == track.uploaded_by or user.is_staff %}
        <div class="mt-3">
            <a href="{% url 'track_edit' track.id %}" class="btn btn-outline-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="{% url 'track_delete' track.id %}" class="btn btn-outline-danger">–£–¥–∞–ª–∏—Ç—å</a>
        </div>
        {% endif %}

        {# –ú–µ—Å—Ç–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–ª—å–±–æ–º–∞—Ö, –ø–ª–µ–π–ª–∏—Å—Ç–∞—Ö... #}

    </div>
    <div class="card-footer text-muted">
        ID: {{ track.pk }}
    </div>
</div>

<a href="{% url 'home' %}" class="btn btn-secondary">&larr; –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

{% endblock %}

{% block extra_scripts %}
{% if user.is_authenticated %}
<script>
// –ü—Ä–æ—Å—Ç–æ–π AJAX –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞
document.addEventListener('DOMContentLoaded', function() {
    const voteButtonsContainer = document.querySelector('.vote-buttons');
    if (!voteButtonsContainer) return;

    const trackId = voteButtonsContainer.dataset.trackId;
    const voteUrl = voteButtonsContainer.dataset.voteUrl;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}'; // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω

    voteButtonsContainer.addEventListener('click', function(event) {
        if (event.target.tagName === 'BUTTON' && event.target.dataset.voteType) {
            const button = event.target;
            const voteType = button.dataset.voteType;

            fetch(voteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `vote_type=${voteType}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                    const likeButton = voteButtonsContainer.querySelector('button[data-vote-type="like"]');
                    const dislikeButton = voteButtonsContainer.querySelector('button[data-vote-type="dislike"]');
                    likeButton.querySelector('.like-count').textContent = data.likes_count;
                    dislikeButton.querySelector('.dislike-count').textContent = data.dislikes_count;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
                    likeButton.classList.remove('active-like');
                    dislikeButton.classList.remove('active-dislike');
                    if (data.user_vote === 1) {
                        likeButton.classList.add('active-like');
                    } else if (data.user_vote === -1) {
                        dislikeButton.classList.add('active-dislike');
                    }
                } else {
                    console.error('Vote failed:', data);
                    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.");
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.");
            });
        }
    });
});
</script>
{% endif %}
{% endblock %} 